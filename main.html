<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>CG-Project Stormtrooper</title>
	</head>

	<body>
		<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
		<script src="js/three.js"></script>
		<script src="js/OBJLoader.js"></script>
		<script src="js/MTLLoader.js"></script>
		<script src="js/Detector.js"></script>

		<script id="vs_BB8" type="x-shader/x-vertex">
		    varying vec2 vUv;
			void main()
			{
				vUv = uv;
				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
				gl_Position = projectionMatrix * mvPosition;
			}
		</script>

		<script id="fs_BB8" type="x-shader/x-fragment">
	        uniform float time;
			uniform vec2 resolution;
			varying vec2 vUv;
			void main( void ) {
				vec2 position = -1.0 + 2.0 * vUv;
				float red = abs( sin( position.x * position.y + time / 5.0 ) );
				float green = abs( sin( position.x * position.y + time / 4.0 ) );
				float blue = abs( sin( position.x * position.y + time / 3.0 ) );
				gl_FragColor = vec4( red, green, blue, 1.0 );
			}
    	</script>

		<script>
			var mainCamera, topCamera, scene, renderer;
			var plane;
			var container;
			var clock = new THREE.Clock();
			var uniforms;
			var obj_strooper;
			var obj_bb8;

			var atualCamera = 0;
			var down = false;


			if (Detector.webgl) {
    			init();
    			animate();
			} else {
			    var warning = Detector.getWebGLErrorMessage();
			    document.getElementById('container').appendChild(warning);
			}
			
			function init(){
				container = document.createElement('div');
				document.body.appendChild(container);

				//Main Camera
				mainCamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
				mainCamera.position.set(0, -5, 3);

				//Top Camera
				topCamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
				topCamera.position.set(0, 4, 15);

				//Scene
				scene = new THREE.Scene();

				//Renderer
				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.shadowMap.enabled = true;
				renderer.shadowMap.type = THREE.PCFSoftShadowMap;
				container.appendChild( renderer.domElement );

				//Grass ground
				var loader = new THREE.TextureLoader();
				var groundTexture = loader.load( 'Textures/grasslight-big.jpg' );
				groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
				groundTexture.repeat.set( 1500, 1500);
				groundTexture.anisotropy = 16;

				var groundMaterial = new THREE.MeshPhongMaterial( { color: 0xffffff, specular: 0x111111, map: groundTexture } );

				var mesh = new THREE.Mesh( new THREE.PlaneBufferGeometry( 20000, 20000 ), groundMaterial );
				mesh.position.y = 0;
				mesh.rotation.x = 0;
				mesh.receiveShadow = true;
				scene.add( mesh );


				//ambient light
				var ambient = new THREE.AmbientLight(0x101010);
				scene.add( ambient );

				//Spotlight
				var spotlight = new THREE.SpotLight( 0xffffff);
				spotlight.position.set(0, 0, 100);
				spotlight.castShadow = true;
				spotlight.shadow.mapSize.width = 1024;
				spotlight.shadow.mapSize.height = 1024;		
				spotlight.shadow.camera.near = 1;
				spotlight.shadow.camera.far = 100;
				spotlight.shadowCameraFOV = 75;
				scene.add ( spotlight );

				// Used in shaders
				uniforms1 = {
					time:       { value: 1.0 },
					resolution: { value: new THREE.Vector2() }
				};

				//load Stormtrooper		
				var mtlLoader = new THREE.MTLLoader();
				mtlLoader.setPath('3DModels/Stormtrooper/');
				mtlLoader.load('Stormtrooper.mtl', function( materials ){

					materials.preload();

					var objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath('3DModels/Stormtrooper/');
					objLoader.load('Stormtrooper.obj', function( object ){
									  	
				  		object.position.set(3, 0, 0);
				  		object.rotation.x = -80.1;
			      		scene.add( object );
			      		obj_strooper = object;
					});
				});
				
				//obj file - load BB8
				loader = new THREE.OBJLoader(); 
				loader.load('3DModels/bb8/bb8.obj',	function ( object ) {

						var bb8Material = new THREE.ShaderMaterial({								
							uniforms : uniforms1,
				   			vertexShader: document.getElementById('vs_BB8').innerHTML,
				   			fragmentShader: document.getElementById('fs_BB8').innerHTML
						});

						object.traverse( function ( child ) {
				        	if ( child instanceof THREE.Mesh ) {				        		
				            	child.material = bb8Material;
				        	}				        	
				    	});
			  						  		
				  		object.scale.set(0.01, 0.01, 0.01);
				  		object.position.set(-3, 0, 0);
				  		object.rotation.x = -80;
			      		scene.add( object );
			      		obj_bb8 = object;
				});

				//obj file - load Arc170				
				var loader = new THREE.OBJLoader(); 						
				loader.load('3DModels/Arc170/Arc170.obj', function ( object ) {
						object.castShadow = true;	
						object.scale.set(0.01, 0.01, 0.01);			  	
				  		object.position.set(0, 5, 5);	
				  		object.rotation.x = -80			  		
			      		scene.add( object );
			      		obj_arc170 = object;
				});
				
				window.addEventListener( 'resize', onWindowResize, false );				

			}

			function onWindowResize() {

				mainCamera.aspect = window.innerWidth / window.innerHeight;
				mainCamera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}					

			function animate() {												
				requestAnimationFrame( animate );
				keymanager();
				render();
			}

			function keymanager(){
				$(document).keydown(function (e) {
					if(!down){
					    if(e.which == 32 && atualCamera == 0){
					    	atualCamera = 1
					    }
					    else if(e.which == 32 && atualCamera == 1){
					    	atualCamera = 0
					    }
					    down = true;
					}
				});

				$(document).keyup(function (e) {
					down = false;
				});
			}
			
			function render() {										
				var delta = clock.getDelta();
				var eTime = clock.getElapsedTime();
				var pressed = 0;

				uniforms1.time.value += delta * 5;
				obj_strooper.rotation.y += 0.03;
				obj_bb8.rotation.y += 0.1;

				var X = scene.position.x + 10 * Math.cos(0.5 * eTime); 						
				var Y = scene.position.y + 10 * Math.sin(0.5 * eTime);				

				var m4 = new THREE.Matrix4;		
				m4.set(	0, 0, 0, X, 
						0, 0, 0, Y, 
						0, 0, 1, 0, 
						0, 0, 0, 1);				
				
				mainCamera.position.applyMatrix4(m4);
				mainCamera.up.set(0, 0, 1);
				mainCamera.lookAt(scene.position);	

				topCamera.up.set(0, 0, 1);
				topCamera.lookAt(scene.position);

				if(atualCamera == 0){
					renderer.render( scene, mainCamera );
				}
				else if(atualCamera == 1){
					renderer.render( scene, topCamera );
				}
			}

		</script>
	</body>
</html>