<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>CG-Project Stormtrooper</title>
	</head>

	<body>
		<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
		<script src="js/three.js"></script>
		<script src="js/OBJLoader.js"></script>
		<script src="js/MTLLoader.js"></script>
		<script src="js/Detector.js"></script>

		<script id="vs_BB8" type="x-shader/x-vertex">
		    varying vec2 vUv;
			void main()
			{
				vUv = uv;
				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
				gl_Position = projectionMatrix * mvPosition;
			}
		</script>

		<script id="fs_BB8" type="x-shader/x-fragment">
	        uniform float time;
			uniform vec2 resolution;
			varying vec2 vUv;
			void main( void ) {
				vec2 position = -1.0 + 2.0 * vUv;
				float red = abs( sin( position.x * position.y + time / 5.0 ) );
				float green = abs( sin( position.x * position.y + time / 4.0 ) );
				float blue = abs( sin( position.x * position.y + time / 3.0 ) );
				gl_FragColor = vec4( red, green, blue, 1.0 );
			}
    	</script>

		<script>
			var rotatingCamera, topCamera, furtherCamera, scene, renderer;
			var plane;
			var container;
			var clock = new THREE.Clock();
			var uniforms;			
			var atualCamera = 0;			
			objs = [];

			if (Detector.webgl) {
    			init();
    			loadObjs();
    			animate();
			} else {
			    var warning = Detector.getWebGLErrorMessage();
			    document.getElementById('container').appendChild(warning);
			}
			
			function init(){
				container = document.createElement('div');
				document.body.appendChild(container);

				//Rotating Camera
				rotatingCamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
				rotatingCamera.position.set(0, -10, 3);

				//Top Camera
				topCamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
				topCamera.position.set(0, 4, 20);

				//Further Camera
				furtherCamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
				furtherCamera.position.set(0, -100, 3);

				//Scene
				scene = new THREE.Scene();

				//Renderer
				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.shadowMap.enabled = true;
				renderer.shadowMap.type = THREE.PCFSoftShadowMap;
				container.appendChild( renderer.domElement );

				//Grass ground
				var loader = new THREE.TextureLoader();
				var groundTexture = loader.load( 'Textures/grasslight-big.jpg' );
				groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
				groundTexture.repeat.set( 1500, 1500);
				groundTexture.anisotropy = 16;
				var groundMaterial = new THREE.MeshPhongMaterial( { color: 0x909090, specular: 0x111111, map: groundTexture } );
				var mesh = new THREE.Mesh( new THREE.PlaneBufferGeometry( 20000, 20000 ), groundMaterial );
				mesh.receiveShadow = true;
				mesh.castShadow = true;
				scene.add( mesh );



				//ambient light
				var ambient = new THREE.AmbientLight(0x101010);
				scene.add( ambient );

				//spotLight
				spotLight = new THREE.SpotLight( 0xffffff, 2 );
				spotLight.position.set(0, 100, 0);
				spotLight.castShadow = true;
				scene.add(spotLight);

				/*
				// Used in shaders
				uniforms1 = {
					time:       { value: 1.0 },
					resolution: { value: new THREE.Vector2() }
				};			
				
				//obj file - load BB8
				loader = new THREE.OBJLoader(); 
				loader.load('3DModels/BB8/BB8.obj',	function ( object ) {

						var bb8Material = new THREE.ShaderMaterial({								
							uniforms : uniforms1,
				   			vertexShader: document.getElementById('vs_BB8').innerHTML,
				   			fragmentShader: document.getElementById('fs_BB8').innerHTML
						});	

						object.traverse( function ( child ) {
				        	if ( child instanceof THREE.Mesh ) {				        		
				            	child.material = bb8Material;
				        	}				        	
				    	});
			  						  		
				  		object.scale.set(0.01, 0.01, 0.01);
				  		object.position.set(-3, 0, 0);
				  		object.rotation.x = -80;
			      		scene.add( object );
			      		obj_bb8 = object;
				});*/				
				
				window.addEventListener( 'resize', onWindowResize, false );				
				window.addEventListener( 'keydown', keyManager );

			}

			function loadObjs() {	
				$.ajax({
				    type: "GET",
				    url: "Config/Models.xml",
				    dataType: "xml",
				    cache: false,
				    async: false,
				    success: function (xml) {			       			    	
				        $(xml).find("Model").each(function() {
				        	var name = $(this).find('Name').text();	
				        	var scaPath = $(this).find('Scale');    	
				        	var posPath = $(this).find('Position');				        	
				        	var rotPath = $(this).find('Rotation');
				        	var x, y, z;

				        	var mtlLoader = new THREE.MTLLoader();
				        	mtlLoader.setPath('3DModels/'+name+'/');						
							mtlLoader.load(name+'.mtl', function( materials ){
								materials.preload();
				        		loader = new THREE.OBJLoader();
				        		loader.setMaterials(materials);
			        			loader.setPath('3DModels/'+name+'/');
			        			loader.load(name+'.obj', function ( object ) {
				        			object.castShadow = true;
				        			object.receiveShadow = true;

				        			// Scale
			        				x = parseFloat(scaPath.find('x').text());
			        				y = parseFloat(scaPath.find('y').text());
			        				z = parseFloat(scaPath.find('z').text());
			        				object.scale.set(x,y,z);

			        				// Position
			        				x = parseFloat(posPath.find('x').text());
			        				y = parseFloat(posPath.find('y').text());
			        				z = parseFloat(posPath.find('z').text());
			        				object.position.set(x,y,z);

			        				// Rotation
			        				x = parseFloat(rotPath.find('x').text());
			        				y = parseFloat(rotPath.find('y').text());
			        				z = parseFloat(rotPath.find('z').text());
			        				object.rotation.set(x,y,z);

			        				//shadow
			        				object.traverse( function ( child ) {
									    if ( child instanceof THREE.Mesh ) {
									        child.castShadow = true;
									        child.receiveShadow = true;

									    }

									} );

			        				scene.add(object);
			        				objs.push(object);
			        			});				        	
				        	});
				        });
				    }
				});
			}

			function onWindowResize() {

				rotatingCamera.aspect = window.innerWidth / window.innerHeight;
				rotatingCamera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}					

			function animate() {												
				requestAnimationFrame( animate );				
				render();
			}

			function keyManager(event){
				if(event.keyCode == 32)
					atualCamera = (atualCamera + 1) % 3;							
			}
			
			function render() {										
				var delta = clock.getDelta();
				var eTime = clock.getElapsedTime();
				var pressed = 0;

				//uniforms1.time.value += delta * 5;
				objs[0].rotation.y += 0.03;
				objs[1].rotation.y += 0.1;				
				objs[2].position.x = scene.position.x + 100 * Math.cos(0.5 * eTime);
				objs[2].position.z = scene.position.z + 100 * Math.sin(0.5 * eTime);	
				objs[3].position.z = 4 * Math.cos(eTime) + 8;

				spotLight.position.y = scene.position.y + 100 * Math.cos(0.5 * eTime);
				spotLight.position.z = scene.position.z + 100 * Math.sin(0.5 * eTime);
				spotLight.lookAt(scene.position);


				var X = scene.position.x + 20 * Math.cos(0.5 * eTime); 						
				var Y = scene.position.y + 20 * Math.sin(0.5 * eTime);				

				var m4 = new THREE.Matrix4;		
				m4.set(	0, 0, 0, X, 
						0, 0, 0, Y, 
						0, 0, 1, 0, 
						0, 0, 0, 1);				
				
				rotatingCamera.position.applyMatrix4(m4);
				rotatingCamera.up.set(0, 0, 1);
				rotatingCamera.lookAt(scene.position);	

				topCamera.up.set(0, 0, 1);
				topCamera.lookAt(scene.position);

				furtherCamera.up.set(0, 0, 1);
				furtherCamera.lookAt(scene.position);

				if (atualCamera == 0){
					renderer.render( scene, rotatingCamera );
				} else if (atualCamera == 1){
					renderer.render( scene, topCamera );
				} else if (atualCamera == 2){
					renderer.render( scene, furtherCamera);
				}			
			}

		</script>
	</body>
</html>