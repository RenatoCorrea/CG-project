<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>CG-Project Stormtrooper</title>
	</head>

	<body>
		<script src="js/three.js"></script>
		<script src="js/OBJLoader.js"></script>
		<script src="js/Detector.js"></script>

		<script id="vs_STrooper" type="x-shader/x-vertex">
		    varying vec2 vUv;
			void main()
			{
				vUv = uv;
				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
				gl_Position = projectionMatrix * mvPosition;
			}
		</script>

		<script id="fs_STrooper" type="x-shader/x-fragment">
	        uniform float time;
			uniform vec2 resolution;
			varying vec2 vUv;
			void main( void ) {
				vec2 position = -1.0 + 2.0 * vUv;
				float red = abs( sin( position.x * position.y + time / 5.0 ) );
				float green = abs( sin( position.x * position.y + time / 4.0 ) );
				float blue = abs( sin( position.x * position.y + time / 3.0 ) );
				gl_FragColor = vec4( red, green, blue, 1.0 );
			}
    	</script>

    	<script id="vs_BB8" type="x-shader/x-vertex">
		    void main() {		    	
			  	gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);			  
			}
		</script>

		<script id="fs_BB8" type="x-shader/x-fragment">
	        void main() {
	        	gl_FragColor = vec4(0.33, 0.213, 0.01, 0.3123);
	        }
    	</script>

		<script>
			var camera, scene, renderer;
			var plane;
			var container;
			var clock = new THREE.Clock();
			var uniforms;
			var obj_strooper;
			var obj_bb8;

			if (Detector.webgl) {
    			init();
    			animate();
			} else {
			    var warning = Detector.getWebGLErrorMessage();
			    document.getElementById('container').appendChild(warning);
			}
			
			function init(){
				container = document.createElement('div');
				document.body.appendChild(container);

				//Camera
				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera.position.set(0, -7, 3);

				//Scene
				scene = new THREE.Scene();

				//Renderer
				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.shadowMap.enabled = true;
				renderer.shadowMap.type = THREE.PCFSoftShadowMap;
				container.appendChild( renderer.domElement );

				//Grass ground
				var loader = new THREE.TextureLoader();
				var groundTexture = loader.load( 'Textures/grasslight-big.jpg' );
				groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
				groundTexture.repeat.set( 1500, 1500 );
				groundTexture.anisotropy = 16;

				var groundMaterial = new THREE.MeshPhongMaterial( { color: 0xffffff, specular: 0x111111, map: groundTexture } );

				var mesh = new THREE.Mesh( new THREE.PlaneBufferGeometry( 20000, 20000 ), groundMaterial );
				mesh.position.y = 0;
				mesh.rotation.x = 0;
				mesh.receiveShadow = true;
				scene.add( mesh );


				//ambient light
				var ambient = new THREE.AmbientLight(0x101030);
				scene.add( ambient );

				//Spotlight
				var spotlight = new THREE.SpotLight( 0xffffff);
				spotlight.position.set(0, -10, 10);
				spotlight.castShadow = true;
				spotlight.shadow.mapSize.width = 1024;
				spotlight.shadow.mapSize.height = 1024;		
				spotlight.shadow.camera.near = 1;
				spotlight.shadow.camera.far = 100;
				spotlight.shadowCameraFOV = 75;
				scene.add ( spotlight );




				//obj file - load Stormtrooper				
				var loader = new THREE.OBJLoader(); 

				
				uniforms1 = {
					time:       { value: 1.0 },
					resolution: { value: new THREE.Vector2() }
				};

				loader.load('3DModels/Stormtrooper/Stormtrooper.obj', function ( object ) {				  					  			
						var sTrooperMaterial = new THREE.ShaderMaterial({							
							uniforms: uniforms1,
				   			vertexShader: document.getElementById('vs_STrooper').innerHTML,
				   			fragmentShader: document.getElementById('fs_STrooper').innerHTML
						});							

						object.traverse( function ( child ) {
				        	if ( child instanceof THREE.Mesh ) {
				            	child.material = sTrooperMaterial;
				        	}				        	
				    	});

				  		object.castShadow = true;				  	
				  		object.position.set(3, 0, 0);
				  		object.rotation.x = -80;
			      		scene.add( object );
			      		obj_strooper = object;			      	
				});

				//obj file - load BB8
				loader = new THREE.OBJLoader(); 
				loader.load('3DModels/bb8/bb8.obj',	function ( object ) {

						var bb8Material = new THREE.ShaderMaterial({								
				   			vertexShader: document.getElementById('vs_BB8').innerHTML,
				   			fragmentShader: document.getElementById('fs_BB8').innerHTML
						});

						object.traverse( function ( child ) {
				        	if ( child instanceof THREE.Mesh ) {
				            	child.material = bb8Material;
				        	}				        	
				    	});

				  		object.castShadow = true;				  						  		
				  		object.scale.set(0.01, 0.01, 0.01);
				  		object.position.set(-3, 0, 0);
				  		object.rotation.x = -80;
			      		scene.add( object );
			      		obj_bb8 = object;
				});

				//Camera look at
				camera.lookAt(scene.position);

				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );
			}

			function animate() {
				requestAnimationFrame( animate );
				render();
			}

			function render() {
				

				var delta = clock.getDelta();
				uniforms1.time.value += delta * 5;
				obj_strooper.rotation.y += 0.03;
				obj_bb8.rotation.y += 0.03;
				renderer.render( scene, camera );
			}
		</script>
	</body>
</html>